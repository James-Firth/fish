<html>
<head>
<style>
    .controls {
        width: 11.7em;
        float: left;
        display: block;
        margin-left: 1em;
        margin-right: 1em;
    }

    .separator {
        clear: both;
    }

    fieldset {
        border: 0px;
    }

    .status-label {
        font-size: 14pt;
    }

    .costs-label {
        font-size: 10pt;
    }

    .info-label {
        width: 5.5em;
        text-align: left;
        display: inline-block;
    }

    #oceanbox {
        width: 800px;
        float: left;
        display: block;
        margin-left: auto;
        margin-right: auto;
    }

    #controlbox {
        width: 800px;
        float: left;
        display: block;
        margin-left: auto;
        margin-right: auto;
    }

    #costsbox {
        width: 200px;
        float: left;
        display: block;
    }

    #infobox {
        width: 600px;
        float: left;
        display: block;
    }

    .red {
        color: red;
    }

    .blue {
        color: darkblue;
    }

    .black {
        color: black;
    }

    .gray {
        color: darkgray;
    }

</style>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script language="JavaScript">

    function getURLParameter(name) {
        return decodeURI(
                (RegExp(name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]
        );
    }

    var group = getURLParameter("gid");
    var pid = getURLParameter("pid");
    console.log("Group: " + group);
    console.log("Participant ID: " + pid);

    var socket = io.connect();
    var gameSettings = null;
    var id = null;
    var agents = null;
    var loop;
    var cCanvas;
    var cContext;
    var oCanvas;
    var oContext;
    var iCanvas;
    var iContext;
    var sailingAllowed = false;
    var fishingAllowed = false;
    var returningAllowed = false;
    var pausable = false;
    var unpausable = false;
    var readRules = false;
    var seconds;
    var fullroom = false;

    var fishImage = new Image();
    var mysteryFishImage = new Image();
    var underwater = new Image();
    fishImage.src = "certain-fish.gif";
    mysteryFishImage.src = "mystery-fish.gif";
    underwater.src = "underwater.jpg";

    socket.on("connect", function (data) {
        socket.emit("join group", group, pid);
    });

    socket.on('gamesettings', function (gs) {
        console.log(gs);
        updateGameSettings(gs);
    });

    socket.on('fullroom', function (group) {
        console.log("The room was full.");
        fullroom = true;
    })

    socket.on('myID', function (myID) {
        console.log(myID);
        id = myID;
    });

    socket.on('myGroup', function (myGroup) {
        console.log(myGroup);
        group = myGroup;
    });

    socket.on('begin', function (data) {
        console.log('Begin simulation.');
        sailingAllowed = true;
        pausable = true;
        updateGameSettings(data);
    });

    socket.on('readying', function (data) {
        console.log('readying');
        sailingAllowed = false;
        fishingAllowed = false;
        updateGameSettings(data);
    });

    socket.on('endseason', function (data) {
        console.log('Current season ended.');
        sailingAllowed = false;
        fishingAllowed = false;
        returningAllowed = false;
        updateGameSettings(data);
    });

    socket.on('gameover', function (data) {
        console.log('Simulation over.');
        sailingAllowed = false;
        fishingAllowed = false;
        returningAllowed = false;
        updateGameSettings(data);
    });

    socket.on('paused', function (data) {
        console.log("Simulation paused by user: " + data.id);
        pausable = false;
        if (id == data.id) {
            unpausable = true;
        }
        pauseMode("resume");
    });

    socket.on('resumed', function (data) {
        console.log("Simulation resumed by user: " + data.id);
        pausable = true;
        unpausable = false;
        pauseMode("pause");
    });

    var pauseMode = function(mode) {
        if (mode == "pause") {
            $("#pause").val("Pause");
            $("#pause").click(pauseClick);

        } else {
            $("#pause").val("Resume");
            $("#pause").click(unpauseClick);
        }
    }

    var updateGameSettings = function(gs) {
        gameSettings = gs;
        displayCosts();
        buttonEnabler();
    }

    var buttonEnabler = function() {
        if (sailingAllowed && gameSettings != null && gameSettings.status != "paused") {
            $("#tosea").removeAttr("disabled");
        } else {
            $("#tosea").attr("disabled", "disabled");
        }

        if (fishingAllowed && gameSettings != null && gameSettings.status != "paused" &&
                gameSettings.certainFish + gameSettings.actualMysteryFish > 0) {
            $("#castfish").removeAttr("disabled");
        } else {
            $("#castfish").attr("disabled", "disabled");
        }

        if (returningAllowed && gameSettings != null && gameSettings.status != "paused") {
            $("#toport").removeAttr("disabled");
        } else {
            $("#toport").attr("disabled", "disabled");
        }

        if (readRules) {
            $("#readrules").attr("disabled", "disabled");
            $("#readrules").hide();
        } else {
            $("#readrules").removeAttr("disabled");
        }

        if (pausable && gameSettings != null && gameSettings.pauseEnabled) {
            $("#pause").removeAttr("disabled");
        } else if (unpausable && gameSettings != null && gameSettings.pauseEnabled) {
            $("#pause").removeAttr("disabled");
        } else {
            $("#pause").attr("disabled", "disabled");
        }
    }

    var goToSeaClick = function() {
        console.log("clicked on go to sea");
        socket.emit("toSea", {id: id});
        sailingAllowed = false;
        fishingAllowed = true;
        returningAllowed = true;
    }

    var returnToPortClick = function() {
        socket.emit("toPort", {id: id});
        sailingAllowed = true;
        fishingAllowed = false;
        returningAllowed = false;
    }

    var castForFishClick = function() {
        if (gameSettings.certainFish + gameSettings.actualMysteryFish <= 1) {
            fishingAllowed = false;
        }
        socket.emit("fishing", {id: id});
    }

    var readRulesClick = function() {
        console.log("clicked on read rules");
        readRules = true;
        gameSettings.players[id].readRules = true;
        socket.emit("readRules", {id: id});
    }

    var pauseClick = function() {
        socket.emit("pauseRequest", {id: id});
    }

    var unpauseClick = function() {
        socket.emit("resumeRequest", {id: id});
    }

    var displayCosts = function() {
        if (gameSettings != null) {
            console.log("displaying costs...");
            $("#fish-value").text("Each fish earns you $" + gameSettings.valueFish);

            if (gameSettings.costCast > 0) {
                $("#cost-cast").text("Casting for a fish costs $" + gameSettings.costCast);
            }

            if (gameSettings.costAtSea > 0) {
                $("#cost-second").text("Each second at sea costs $" + gameSettings.costAtSea);
            }

            if (gameSettings.costDepart > 0) {
                $("#cost-leave").text("Leaving port costs $" + gameSettings.costDepart);
            }
        }
    }

    var displayStatus = function() {
        if (gameSettings == null && !fullroom) {
            $("#status-box").addClass("blue");
            $("#status-box").text("Please wait - loading the application");
        } else if (fullroom) {
            $("#status-box").addClass("blue");
            $("#status-box").text("The group you tried to join is full. Please notify the experimenter.");
        } else if (gameSettings != null && gameSettings.status == "readying") {
            $("#status-box").addClass("red");
            $("#status-box").text("Get ready! The simulation is about to start.");
        } else if (gameSettings != null && gameSettings.status == "running") {
            minFish = gameSettings.certainFish;
            maxFish = minFish + gameSettings.mysteryFish;
            $("#status-box").addClass("black");
            if (minFish == maxFish) {
                $("#status-box").text("This is season " + gameSettings.currentSeason + ". " +
                        "There are " + minFish + " fish remaining.");
            } else {
                $("#status-box").text("This is season " + gameSettings.currentSeason + ". " +
                        "There are between " + minFish + " and " + maxFish + " fish remaining.");
            }
        } else if (gameSettings != null && gameSettings.status == "resting") {
            $("#status-box").addClass("black");
            $("#status-box").text("We are in between seasons.")
        } else if (gameSettings != null && gameSettings.status == "paused") {
            $("#status-box").addClass("gray");
            $("#status-box").text("Simulation paused.");
        } else {
            // Other states (over, waiting) have an empty status box
            $("#status-box").text("");
        }
        displayWarning();
    }

    var displayWarning = function() {
        if (gameSettings != null && gameSettings.status == "running"
                && gameSettings.seasonDuration - gameSettings.currentSeconds < 10) {
            $("#warning-box").addClass("red");
            $("#warning-box").text("   Warning: this season is about to end.");
        } else if (gameSettings != null && gameSettings.status == "resting"
                && gameSettings.restDuration - gameSettings.currentSeconds < 5) {
            $("#warning-box").addClass("blue");
            $("#warning-box").text("   Get ready: the next season is about to start.");
        } else {
            $("#warning-box").text("");
        }
    }

    var Main = function() {
        buttonEnabler();
        $("#tosea").click(goToSeaClick);
        $("#toport").click(returnToPortClick);
        $("#castfish").click(castForFishClick);
        $("#readrules").click(readRulesClick);
        $("#pause").click(pauseClick);
    }

    $(document).ready(Main);

</script>

<title>FISH</title>

<script language="JavaScript">
// TODO: Rewrite the assignment of coordinates of fish in the screen.
// We'll have only 'small' fish images, each representing one fish.
function Coords() {
    this.x = 0;
    this.y = 0;
}

var largeFishSpots = new Array();
for (i = 0; i < 6; i++) {
    largeFishSpots[i] = new Coords();
}
largeFishSpots[0].x = 100;
largeFishSpots[0].y = 100;
largeFishSpots[1].x = 500;
largeFishSpots[1].y = 300;
largeFishSpots[2].x = 300;
largeFishSpots[2].y = 100;
largeFishSpots[3].x = 500;
largeFishSpots[3].y = 100;
largeFishSpots[4].x = 100;
largeFishSpots[4].y = 300;
largeFishSpots[5].x = 300;
largeFishSpots[5].y = 300;

var midFishSpots = new Array();
for (i = 0; i < 6; i++) {
    midFishSpots[i] = new Coords();
}
midFishSpots[0].x = 100;
midFishSpots[0].y = 400;
midFishSpots[1].x = 200;
midFishSpots[1].y = 400;
midFishSpots[2].x = 400;
midFishSpots[2].y = 200;
midFishSpots[3].x = 600;
midFishSpots[3].y = 200;
midFishSpots[4].x = 200;
midFishSpots[4].y = 200;
midFishSpots[5].x = 600;
midFishSpots[5].y = 400;

var smallFishSpots = new Array();
for (i = 0; i < 8; i++) {
    smallFishSpots[i] = new Coords();
}
smallFishSpots[0].x = 490;
smallFishSpots[0].y = 290;
smallFishSpots[1].x = 290;
smallFishSpots[1].y = 90;
smallFishSpots[2].x = 590;
smallFishSpots[2].y = 90;
smallFishSpots[3].x = 590;
smallFishSpots[3].y = 390;
smallFishSpots[4].x = 90;
smallFishSpots[4].y = 90;
smallFishSpots[5].x = 90;
smallFishSpots[5].y = 390;
smallFishSpots[6].x = 490;
smallFishSpots[6].y = 390;
smallFishSpots[7].x = 190;
smallFishSpots[7].y = 190;

var tinyFishSpots = new Array();
for (i = 0; i < 8; i++) {
    tinyFishSpots[i] = new Coords();
}
tinyFishSpots[0].x = 620;
tinyFishSpots[0].y = 120;
tinyFishSpots[1].x = 20;
tinyFishSpots[1].y = 220;
tinyFishSpots[2].x = 20;
tinyFishSpots[2].y = 420;
tinyFishSpots[3].x = 420;
tinyFishSpots[3].y = 320;
tinyFishSpots[4].x = 420;
tinyFishSpots[4].y = 120;
tinyFishSpots[5].x = 720;
tinyFishSpots[5].y = 120;
tinyFishSpots[6].x = 720;
tinyFishSpots[6].y = 420;
tinyFishSpots[7].x = 320;
tinyFishSpots[7].y = 120;

// TODO: This function will need to be updated with the new fish drawing approach.
function drawFish(oContext, image, size, x, y) {
    oContext.fillStyle = "black";
    if (size == 100) {
        oContext.font = "14px sans-serif";
        oContext.drawImage(image, x, y);
        oContext.fillText("100", x + 80, y + 110);
    } else if (size == 25) {
        oContext.font = "14px sans-serif";
        oContext.drawImage(image, x, y, 100, 100);
        oContext.fillText("25", x + 40, y + 55);
    } else if (size == 5) {
        oContext.font = "10px sans-serif";
        oContext.drawImage(image, x, y, 50, 50);
        oContext.fillText("5", x + 20, y + 30);
    } else {
        oContext.drawImage(image, x, y, 25, 25);
    }
}

function drawBackground(oContext, image, x1, y1, x2, y2) {
    oContext.drawImage(image, x1, y1, x2, y2);
}

// TODO: As per issue #89, this will need a currency symbol parameter.
function performanceReportText() {
    rep = "This simulation is over.\n\n";
    if (gameSettings.depleted) {
        rep += gameSettings.depletedText + "\n\n";
    } else {
        rep += gameSettings.endText + "\n\n";
    }
    rep += "You caught " + gameSettings.players[id].fishCaught + " fish.\n";
    rep += "You ended with " + gameSettings.players[id].money + " money.\n";
    return rep;
}

// TODO: See if I can get rid of this silliness with a text box I can hide later.
function writeTextblockInCanvas(ctx, txt, width, height) {
    var fitWidth = width;
    var lineHeight = height;
    var lines = txt.split('\n');
    var currentLine = 0;
    for (i = 0; i < lines.length; i++) {
        var words = lines[i].split(' ');
        var idx = 1;
        while (words.length > 0 && idx <= words.length) {
            var str = words.slice(0, idx).join(' ');
            var w = ctx.measureText(str).width;
            if ( w > fitWidth ) {
                if (idx==1) {
                    idx=2;
                }
                ctx.fillText( words.slice(0, idx-1).join(' '), 20, 60 + (lineHeight*currentLine) );
                currentLine++;
                words = words.splice(idx-1);
                idx = 1;
            } else {
                idx++;
            }
        }
        if  (idx > 0) {
            ctx.fillText( words.join(' '), 20, 60 + (lineHeight*currentLine) );
            currentLine++;
        }
    }
}

// TODO: Rewrite. Handling of status messages is now separate from drawing the ocean.
function drawOcean() {
    oCanvas = document.getElementById("oceanCanvas");
    oContext = oCanvas.getContext("2d");
    displayStatus();

    // Readying mode --- show preparation text
    if (gameSettings != null && (gameSettings.status == "waiting" || gameSettings.status == "readying")) {
        oContext.fillStyle = "white";
        oContext.fillRect(0, 40, 800, 460);
        oContext.fillStyle = "black";
        oContext.font = "12px Courier";
        writeTextblockInCanvas(oContext, gameSettings.prepText, 760, 15);
    }

    // Over mode --- show performance report
    if (gameSettings != null && gameSettings.status == "over") {
        oContext.font = "16px sans-serif";
        oContext.fillStyle = "darkgray";
        oContext.fillText("Simulation over.", 10, 20);
        oContext.fillStyle = "white";
        oContext.fillRect(0, 40, 800, 460);
        oContext.fillStyle = "black";
        oContext.font = "14px Courier";
        writeTextblockInCanvas(oContext, performanceReportText(), 760, 15);
    }

    // Running, resting, or paused.
    if (gameSettings != null && (gameSettings.status == "running" || gameSettings.status == "resting" || gameSettings.status == "paused")) {
        drawBackground(oContext, underwater, 0, 40, 800, 460);

        var certain = gameSettings.certainFish;
        var mystery = gameSettings.mysteryFish;
        var idxLarge = 0;
        var idxMid = 0;
        var idxSmall = 0;
        var idxTiny = 0;
        while (certain >= 100) {
            drawFish(oContext, fishImage, 100, largeFishSpots[idxLarge].x, largeFishSpots[idxLarge].y);
            idxLarge++;
            certain -= 100;
        }
        while (certain >= 25) {
            drawFish(oContext, fishImage, 25, midFishSpots[idxMid].x, midFishSpots[idxMid].y);
            idxMid++;
            certain -= 25;
        }
        while (certain >= 5) {
            drawFish(oContext, fishImage, 5, smallFishSpots[idxSmall].x, smallFishSpots[idxSmall].y);
            idxSmall++;
            certain -= 5;
        }
        while (certain > 0) {
            drawFish(oContext, fishImage, 1, tinyFishSpots[idxTiny].x, tinyFishSpots[idxTiny].y);
            idxTiny++;
            certain -= 1;
        }
        while (mystery >= 100) {
            drawFish(oContext, mysteryFishImage, 100, largeFishSpots[idxLarge].x, largeFishSpots[idxLarge].y);
            idxLarge++;
            mystery -= 100;
        }
        while (mystery >= 25) {
            drawFish(oContext, mysteryFishImage, 25, midFishSpots[idxMid].x, midFishSpots[idxMid].y);
            idxMid++;
            mystery -= 25;
        }
        while (mystery >= 5) {
            drawFish(oContext, mysteryFishImage, 5, smallFishSpots[idxSmall].x, smallFishSpots[idxSmall].y);
            idxSmall++;
            mystery -= 5;
        }
        while (mystery > 0) {
            drawFish(oContext, mysteryFishImage, 1, tinyFishSpots[idxTiny].x, tinyFishSpots[idxTiny].y);
            idxTiny++;
            mystery -= 1;
        }
    }
}

function clearOcean() {
    oCanvas = document.getElementById("oceanCanvas");
    oContext = oCanvas.getContext("2d");
    oContext.clearRect(0,0,800,500);
}

// TODO: This will not be necessary.
function drawInfoHeader(ctx, edgeX, topY) {
    ctx.fillStyle = "black";
    ctx.font = "14px sans-serif";
    ctx.fillText("Fisher", edgeX, topY + 20);
    ctx.fillText("Status", edgeX + 100, topY + 20);
    ctx.fillText("Fish caught", edgeX + 150, topY);
    ctx.fillText("This season", edgeX + 150, topY + 20);
    ctx.fillText("Overall", edgeX + 250, topY + 20);
    ctx.fillText("Profits", edgeX + 350, topY);
    ctx.fillText("This season", edgeX + 350, topY + 20);
    ctx.fillText("Overall", edgeX + 450, topY + 20);
}

// TODO: This will be superseded by the info box.
function drawInfo() {
    if (gameSettings != null) {
        iCanvas = document.getElementById("infoCanvas");
        iContext = iCanvas.getContext("2d");

        iContext.fillStyle = "aliceblue";
        iContext.fillRect(0, 10, 380, 135);
        iContext.fillRect(190, 10, 190, 135);
        iContext.fillRect(390, 10, 410, 135);

        if (gameSettings.status != "waiting" && gameSettings.status != "readying") {
            drawInfoHeader(iContext, 50, 30);
            iContext.fillStyle = "black";
            iContext.font = "14px sans-serif";
            var skippedFishers = 0;
            var offsetFisherLine = 70;

            for (i = 0; i < gameSettings.players.length; i++) {
                if (gameSettings.players[i].name == pid) {
                    // Found the record that corresponds to this player. Display it first.
                    iContext.fillText("You", 50, offsetFisherLine);
                    iContext.fillText(gameSettings.players[i].status, 150, offsetFisherLine);
                    iContext.fillText(gameSettings.players[i].fishCaughtPerSeason[gameSettings.currentSeason], 200, offsetFisherLine);
                    iContext.fillText(gameSettings.players[i].fishCaught, 300, offsetFisherLine);
                    iContext.fillText(gameSettings.players[i].endMoneyPerSeason[gameSettings.currentSeason] - gameSettings.players[i].startMoneyPerSeason[gameSettings.currentSeason], 400, offsetFisherLine);
                    iContext.fillText(gameSettings.players[i].money - gameSettings.players[i].startMoney, 500, offsetFisherLine);
                    offsetFisherLine += 20;
                }
            }

            // Go through the rest of the fishers
            for (i = 0; i < gameSettings.players.length; i++) {
                if (gameSettings.players[i].name != pid) {
                    if (gameSettings.showOtherFishers) {
                        if (gameSettings.showFisherNames) {
                            iContext.fillText(gameSettings.players[i].name, 50, offsetFisherLine);
                        } else {
                            iContext.fillText("?????", 50, offsetFisherLine);
                        }
                        if (gameSettings.showFisherStatus) {
                            iContext.fillText(gameSettings.players[i].status, 150, offsetFisherLine);
                        }
                        if (gameSettings.showFishCaught) {
                            iContext.fillText(gameSettings.players[i].fishCaughtPerSeason[gameSettings.currentSeason], 200, offsetFisherLine);
                            iContext.fillText(gameSettings.players[i].fishCaught, 300, offsetFisherLine);
                        }
                        if (gameSettings.showBalance) {
                            iContext.fillText(gameSettings.players[i].endMoneyPerSeason[gameSettings.currentSeason] - gameSettings.players[i].startMoneyPerSeason[gameSettings.currentSeason], 400, offsetFisherLine);
                            iContext.fillText(gameSettings.players[i].money - gameSettings.players[i].startMoney, 500, offsetFisherLine);
                        }
                        offsetFisherLine += 20;
                    }
                }
            }
        }
        if (gameSettings.debug == true) {
            iContext.fillText(gameSettings.status, 50, 160);
        }
    }
}

function drawAll() {
    clearOcean();
    drawOcean();
    loop = setTimeout('drawAll()', 1000);
}
</script>
</head>


<body onload="drawAll()">
<div id="statusbox">
    <label class="status-label" id="status-box"></label>
    <label class="status-label" id="warning-box"></label>
</div>
<div class="separator">
</div>
<div id="oceanbox">
    <canvas id="oceanCanvas" width="800" height="460"></canvas>
</div>
<div class="separator">
</div>
<div id="controlbox">
    <fieldset>
        <input type="button" class="controls" id="readrules" value="Go fishing!">
        <input type="button" class="controls" id="tosea" value="Go to sea">
        <input type="button" class="controls" id="castfish" value="Cast for one fish">
        <input type="button" class="controls" id="toport" value="Return to port">
        <input type="button" class="controls" id="pause" value="Pause">
    </fieldset>
</div>
<div class="separator">
</div>
<div id="costsbox">
    <fieldset>
        <label class="costs-label" id="fish-value"></label>
        <br>
        <label class="costs-label" id="cost-cast"></label>
        <br>
        <label class="costs-label" id="cost-second"></label>
        <br>
        <label class="costs-label" id="cost-leave"></label>
    </fieldset>
</div>
<div id="infobox">
    <fieldset>
        <label class="info-label fisher-name-label"></label>
        <label class="info-label fisher-status-label"></label>
        <label class="info-label fish-caught-season-label"><b>Fish caught</b></label>
        <label class="info-label fish-caught-all-label"></label>
        <label class="info-label profits-season-label"><b>Profits</b></label>
        <label class="info-label profits-all-label"></label>
        <div class="separator"></div>
        <label class="info-label fisher-name-label"><b>Fisher</b></label>
        <label class="info-label fisher-status-label"><b>Location</b></label>
        <label class="info-label fish-caught-season-label"><b>Season</b></label>
        <label class="info-label fish-caught-all-label"><b>Overall</b></label>
        <label class="info-label profits-season-label"><b>Season</b></label>
        <label class="info-label profits-all-label"><b>Overall</b></label>

        <br>
        <label>Fisher 1</label>
        <br>
        <label>Fisher 2</label>
        <br>
        <label>Fisher 3</label>
        <br>
        <label>Fisher 4</label>
    </fieldset>
</div>
</body>
</html>
