<html>
<head>
    <style>
        legend {
            text-align: center;
            font-size: 16pt;
        }

        .left-side-label {
            width: 12em;
            float: left;
            text-align: right;
            margin-right: 0.5em;
            display: block;
        }

        fieldset {
            border: 1px solid #dadada;
            width: 28em;
        }

        .status-message {
            font-size: 10pt;
            color: red;
        }

    </style>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" charset="utf-8" src="localization.js"></script>
    <script type="text/javascript" language="JavaScript">
        function getValue(varname) {
            var url = window.location.href;
            var qparts = url.split("?");
            if (qparts.length < 2) {
                return "";
            }
            var query = qparts[1];
            var vars = query.split("&");
            var value = "";
            for (i = 0; i < vars.length; i++) {
                var parts = vars[i].split("=");
                if (parts[0] == varname) {
                    value = parts[1];
                    break;
                }
            }
            value = unescape(value);
            value.replace(/\+/g," ");
            return value;
        }

        var lang = getValue("lang").toLowerCase();
        var messages;
        if (lang != "" && lang in langs) {
            messages = langs[lang];
        } else {
            messages = langs['en'];
            lang = "en";
        }

        var socket = io.connect();

        socket.on("connect", function (data) {
            console.log("Connected to server.");
        });

        socket.on("valid-group", function() {
            // Go to main window
            location.href = "main.html?gid=" + $("#gid").val() +
                    "&pid=" + $("#pid").val() +
                    "&lang=" + lang;
        });

        socket.on("invalid-group", function() {
            $("#login").prop("disabled", false);
            $(".status-message").toggleClass("red");
            $(".status-message").text(messages['login_invalidGroup']);
        });

        var ValidateGroupAndUser = function () {
            var gid = $("#gid").val()
            $("#login").prop("disabled", true);
            $(".status-message").text(messages['login_validating']);
            console.log("Requesting server to validate group id " + gid);
            socket.emit("validate group", gid);

            // TODO - validate user
        }

        var Main = function() {
            document.title = messages['login_title'];
            $("#welcome").text(messages['login_welcome']);
            $("#welcome").text(messages['login_welcome']);
            $("#instructions").text(messages['login_instructions']);
            $("#gid_label").text(messages['login_simulationName'] + " ");
            $("#pid_label").text(messages['login_participantId'] + " ");
            $("#login").text(messages['login_getStarted']);
            $("#login").click(ValidateGroupAndUser);
        }

        $(document).ready(Main);

    </script>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
</head>

<body>
<form action="fish">
    <fieldset>
        <legend id="welcome"></legend>
        <br>
        <div id="instructions"></div>
        <br><br>
        <label id="gid_label" for="gid" class="left-side-label"></label>
        <input type="text" name="gid" id="gid" autofocus/>
        <br>
        <label id="pid_label" for="pid" class="left-side-label"></label>
        <input type="text" name="pid" id="pid"/>
        <br><br>
        <button type="button" id="login"></button>
        <br>
        <label id="status_message" class="status-message"></label>
    </fieldset>
</form>
</body>
</html>
